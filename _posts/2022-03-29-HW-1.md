---
layout: post
title:  "Exploring Climate Data"
categories: blog assignment
permalink: posts/blog-post-1
author: Pei Xi Kwok
---

In this blog post, we'll create several interesting, interactive data graphics using the NOAA climate data. 
We begin by importing the necessary packages, as well as the csv files.

```python
# import packages
import pandas as pd
import numpy as np
import plotly.express as px
import sqlite3

# read in csv files
temps = pd.read_csv("temps_stacked-Copy1.csv")
countries = pd.read_csv('countries-Copy1.csv')
url = "https://raw.githubusercontent.com/PhilChodrow/PIC16B/master/datasets/noaa-ghcn/station-metadata.csv"
stations = pd.read_csv(url)

# rename column FIPS 10-4 for ease in later queries
countries = countries.rename(columns={"FIPS 10-4":"FIPS_10_4"})
```

## 1. Creating a database

First, let us read in create a database with three tables: `temperatures`, `stations`, and `countries`.  

```python
# form a connection using connect method
conn = sqlite3.connect("temps.db")

# converts dataframes to sql
temps.to_sql("temperatures",conn,if_exists="replace", index=False)
countries.to_sql("countries",conn,if_exists="replace",index=False)
stations.to_sql("stations",conn,if_exists="replace",index=False)

# close the connection
conn.close()
```

## 2. Creating a query function to explore the database

We want to query our database in order to start making sense of it. Let's begin by getting temperature readings for all stations country in a specific date range and a specific month. To do that, we will create a query function.

```python
def query_climate_database(country, year_begin, year_end, month):
    """
    Executes a query to get temperature readings for a country in a specific date range and a specific month
    
    country: a string giving the name of a country (e.g. ‘South Korea’) for which data should be returned
    year_begin, year_end: two integers giving the earliest and latest years for which should be returned
    month: integer giving the month of the year for which should be returned
    
    returns Pandas dataframe of temperature readings for the specified country in the specified date range,
    in the specified month of the year
    """
    # identify country id
    country_id = countries["FIPS_10_4"][countries["Name"] == country].values[0]
    
    # create parameters using user input 
    param1 = (country_id,year_begin,year_end,month)
    
    # create query
    # use left join to join stations and temperature tables
    # use substring to identify country id for query
    query1 = \
    """
    SELECT s.name, s.latitude, s.longitude, c.name, t.year, t.month, t.temp
    FROM temperatures t
    LEFT JOIN stations s ON t.id = s.id
    LEFT JOIN countries c ON SUBSTRING(t.id,1,2)=c.FIPS_10_4
    WHERE SUBSTRING(t.id,1,2)=? AND (t.year BETWEEN ? AND ?) AND (t.month=?)
    """
    
    # reads result of query with parameters to a pandas dataframe
    df = pd.read_sql_query(query1, conn, params=param1)
    
    return df
```

Let's test our function!

```python
query_climate_database(country = "India", 
                       year_begin = 1980, 
                       year_end = 2020,
                       month = 1)
```


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>LATITUDE</th>
      <th>LONGITUDE</th>
      <th>Country</th>
      <th>Year</th>
      <th>Month</th>
      <th>Temp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1980</td>
      <td>1</td>
      <td>23.48</td>
    </tr>
    <tr>
      <th>1</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1981</td>
      <td>1</td>
      <td>24.57</td>
    </tr>
    <tr>
      <th>2</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1982</td>
      <td>1</td>
      <td>24.19</td>
    </tr>
    <tr>
      <th>3</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1983</td>
      <td>1</td>
      <td>23.51</td>
    </tr>
    <tr>
      <th>4</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1984</td>
      <td>1</td>
      <td>24.81</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3147</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1983</td>
      <td>1</td>
      <td>5.10</td>
    </tr>
    <tr>
      <th>3148</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1986</td>
      <td>1</td>
      <td>6.90</td>
    </tr>
    <tr>
      <th>3149</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1994</td>
      <td>1</td>
      <td>8.10</td>
    </tr>
    <tr>
      <th>3150</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1995</td>
      <td>1</td>
      <td>5.60</td>
    </tr>
    <tr>
      <th>3151</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1997</td>
      <td>1</td>
      <td>5.70</td>
    </tr>
  </tbody>
</table>
<p>3152 rows × 7 columns</p>
</div>


## 3. Creating visualizations using our database and query results 

Now let's try to create visualizations using our query results. In particular, we want to address the following question: 

> How does the average yearly change in temperature vary within a given country? 

We will do so by write a function called `temperature_coefficient_plot()`, which will create a geographic scatter function that illustrates yearly temperature increases.

In order to calculate year-over-year change in temperature, we will make use of the coefficients derived from a linear regression model.

```python
# import linear regression model from sklearn
from sklearn.linear_model import LinearRegression

def coef(data_group):
    """
    Computes first coefficient of a linear regression model at a given station
    
    data_group: groupby object grouped based on station name
    
    returns first coefficient of LR model for a given station rounded to 4dp
    """
    # assign "Year" as X variable and "Temp" as Y variable
    X = data_group[["Year"]]
    Y = data_group["Temp"]
    
    # create an instance of a linear regression model
    LR = LinearRegression()
    
    # fit model to X and Y
    LR.fit(X,Y)
    
    # retrieve first coefficient and rounds to 4dp
    slope = LR.coef_[0].round(decimals = 4)
    
    return slope
```

Now that we have that set up, let's try to define a function that will generate an interactive geographic scatterplot that shows us the estimated yearly increases in a specific month and interval in a given country.

```python
def temperature_coefficient_plot(country, year_begin, year_end, month, min_obs, **kwargs):
    """
    Creates an interactive geographic scatterplot to determine how the average yearly change in 
    temperature varies within a given country
    
    country: a string giving the name of a country (e.g. ‘South Korea’) for which data should be returned
    year_begin, year_end: two integers giving the earliest and latest years for which should be returned
    month: integer giving the month of the year for which should be returned
    min_obs: the minimum required number of years of data for any given station.
    **kwargs: additional keyword arguments passed to px.scatter_mapbox() e.g. colormap used, mapbox style
    
    returns an interactive geographic scatterplot with a point for each station
    where color reflects an estimate of yearly change in temperature in the specified month of the given station
    """
    
    # call query_climate_database to obtain dataframe with necessary temp readings
    df = query_climate_database(country, year_begin, year_end, month)
    
    # limit data to stations with min_obs no. of years of data
    df = df.loc[df.groupby(["NAME"])["Year"].transform('count') >= min_obs]
    
    # call coef to generate an estimate of the yearly change in temperature
    df["Estimated Yearly Change (°C)"] = df["NAME"].map(df.groupby(["NAME"]).apply(coef))
    
    # dict to index month name for title 
    title_month = {
        1:"January",
        2:"February",
        3:"March",
        4:"April",
        5:"May",
        6:"June",
        7:"July",
        8:"August",
        9:"September",
        10:"October",
        11:"November",
        12:"December"
    }
    
    # string for plot title
    title_str = "Estimates of yearly change in temperature in " + title_month[month] + " for stations in " + country + ", years " + str(year_begin) + "-" + str(year_end)
    
    # create plot
    fig = px.scatter_mapbox(df,
                           lat = "LATITUDE",
                           lon = "LONGITUDE",
                           hover_name = "NAME",
                            title = title_str,
                            color = "Estimated Yearly Change (°C)",
                            color_continuous_midpoint=0,
                            **kwargs)
    
    # adjusts margins
    fig.update_layout(margin={"r":0,"t":50,"l":0,"b":0})
    
    return fig
```

Let's test it out. Say I want to create a plot of estimated yearly increases in temperature during the month of January, in the interval 1980-2020, in India: 

```python
# assumes you have imported necessary packages
color_map = px.colors.diverging.RdGy_r # choose a colormap

fig = temperature_coefficient_plot("India", 1980, 2020, 1, 
                                   min_obs = 10,
                                   zoom = 2,
                                   mapbox_style="carto-positron",
                                   color_continuous_scale=color_map)

fig.show()
```

<div class = "display">
{% include india-HW1-example.html %}
</div>

Let's try it out on something else. Say I want to create a plot for estimated yearly increases in temperature during the month of January, in the interval 1980-2020 for Brazil:

```python
fig = temperature_coefficient_plot("Brazil", 1980, 2020, 1, 
                                   min_obs = 10,
                                   zoom = 2,
                                   mapbox_style="carto-positron",
                                   color_continuous_scale=color_map)

fig.show()
```

## §4. Create Two More Interesting Figures

Create at least one more SQL query function and at least two more complex and interesting interactive data visualizations using the same data set. These plots must be of different *types* (e.g. line and bar, scatter and histogram, etc). The code to construct each visualization should be wrapped in functions, such that a user could create visualizations for different parts of the data by calling these functions with different arguments. At least one of these plots must involve multiple facets (i.e. multiple axes (in the sense of facets), each of which shows a subset of the data). 

Alongside the plots, you should clearly state a question that the plot addresses, similar to the question that we posed in §3. The questions for your two additional plots should be meaningfully different from each other and from the §3 question. You will likely want to define different query functions for extracting data for these new visualizations.  

It is not necessary to create *geographic* plots for this part. Scatterplots, histograms, and line plots (among other choices) are all appropriate. Please make sure that they are complex, engaging, professional, and targeted to the questions you posed. In other words, *push yourself!* Don't hesitate to ask your peers or talk to me if you're having trouble coming up with questions or identifying plots that might be suitable for addressing those questions. 

Once you're done, commit and push your post to publish it to the web. Then, print the webpage as a PDF and submit it on Gradescope. 